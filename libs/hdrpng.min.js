(function(n,v,q){"undefined"!=typeof module&&module.exports?module.exports=q():"function"==typeof define&&define.amd?define(n,q):v[n]=q()})("HDRImage",this,function(){function n(){var b=document.createElement("canvas"),d="t",f=1,c=2.2,l=null,g,h;b.__defineGetter__("exposure",function(){return f});b.__defineSetter__("exposure",function(b){f=b;l&&(r(l,f,c,h.data),g.putImageData(h,0,0))});b.__defineGetter__("gamma",function(){return c});b.__defineSetter__("gamma",function(b){c=b;l&&(r(l,f,c,h.data),
g.putImageData(h,0,0))});b.__defineGetter__("dataFloat",function(){return w(l)});b.__defineGetter__("dataRGBE",function(){return l});b.toHDRBlob=function(c,b,a){function g(a,c,b){b=a.createShader(b);a.shaderSource(b,c);a.compileShader(b);return b}var d=b&&b.match(/rgb9_e5/i)?new Uint8Array(x(w(l)).buffer):new Uint8Array(l.buffer),f=this.width,h=this.height;if(f*h*4<d.byteLength)return console.error("not big enough.");b=document.createElement("canvas");b.width=f;b.height=h;a=b.getContext("webgl",{antialias:!1,
alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0});var k=a.createTexture();a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,k);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,f,h,0,a.RGBA,a.UNSIGNED_BYTE,new Uint8Array(d.buffer));
d=function(a,c,b){var d=a.createProgram();a.attachShader(d,c=g(a,c,a.VERTEX_SHADER));a.attachShader(d,b=g(a,b,a.FRAGMENT_SHADER));a.linkProgram(d);a.deleteShader(c);a.deleteShader(b);return d}(a,"precision highp float;\nattribute vec3 position;\nvarying vec2 tex;\nvoid main() { tex = position.xy/2.0+0.5; gl_Position = vec4(position, 1.0); }","precision highp float;\nprecision highp sampler2D;\nuniform sampler2D tx;\nvarying vec2 tex;\nvoid main() { gl_FragColor = texture2D(tx,tex); }");f=a.getUniformLocation(d,
"tx");h=new Float32Array([-1,-1,0,1,-1,0,1,1,0,1,1,0,-1,1,0,-1,-1,0]);var m=a.createBuffer();a.enableVertexAttribArray(0);a.bindBuffer(a.ARRAY_BUFFER,m);a.bufferData(a.ARRAY_BUFFER,h,a.STATIC_DRAW);a.vertexAttribPointer(0,3,a.FLOAT,!1,0,0);a.useProgram(d);a.uniform1i(f,0);a.drawArrays(a.TRIANGLES,0,6);a.deleteTexture(k);a.deleteProgram(d);if(c)return b.toBlob(c)};b.__defineGetter__("src",function(){return d});b.__defineSetter__("src",function(k){d=k;g&&g.clearRect(0,0,this.width,this.height);if(k.match(/\.hdr$/i))q(k,
function(a,b,d){l=a;this.width=this.style.width=b;this.height=this.style.height=d;g=this.getContext("2d");h=g.getImageData(0,0,b,d);r(a,f,c,h.data);g.putImageData(h,0,0);this.onload&&this.onload()}.bind(b));else if(k.match(/\.rgb9_e5\.png$/i)){var m=new Image;m.src=k;m.onload=function(){var a=document.createElement("canvas"),b=this.width=this.style.width=a.width=m.width,d=this.height=this.style.height=a.height=m.height;a=a.getContext("webgl");var k=a.createTexture();a.bindTexture(a.TEXTURE_2D,k);
a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,m);fb=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,fb);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,k,0);var n=new Uint8Array(b*d*4);a.readPixels(0,0,b,d,a.RGBA,a.UNSIGNED_BYTE,n);a.deleteTexture(k);a.deleteFramebuffer(fb);this.dataRAW=new Uint32Array(n.buffer);l=y(z(this.dataRAW));g=this.getContext("2d");h=g.getImageData(0,0,b,d);r(l,f,c,h.data);g.putImageData(h,0,0);this.onload&&this.onload()}.bind(b)}else k.match(/\.hdr\.png$|\.rgbe\.png/i)&&
(m=new Image,m.src=k,m.onload=function(){var a=document.createElement("canvas"),b=this.width=this.style.width=a.width=m.width,d=this.height=this.style.height=a.height=m.height;a=a.getContext("webgl");var k=a.createTexture();a.bindTexture(a.TEXTURE_2D,k);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,m);fb=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,fb);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,k,0);var n=new Uint8Array(b*d*4);a.readPixels(0,0,b,d,a.RGBA,
a.UNSIGNED_BYTE,n);a.deleteTexture(k);a.deleteFramebuffer(fb);l=n;g=this.getContext("2d");h=g.getImageData(0,0,b,d);r(l,f,c,h.data);g.putImageData(h,0,0);this.onload&&this.onload()}.bind(b))});return b}function v(b,d){for(var f in d)b[f]=d[f];return b}function q(b,d){var f=v(new XMLHttpRequest,{responseType:"arraybuffer"});f.onerror=d.bind(f,!1);f.onload=function(){if(400<=this.status)return this.onerror();for(var c="",f=0,g=new Uint8Array(this.response),h;!c.match(/\n\n[^\n]+\n/g);)c+=String.fromCharCode(g[f++]);
h=c.match(/FORMAT=(.*)$/m)[1];if("32-bit_rle_rgbe"!=h)return console.warn("unknown format : "+h),this.onerror();h=c.split(/\n/).reverse()[1].split(" ");c=1*h[3];h=1*h[1];for(var k=new Uint8Array(c*h*4),m=0,a=0;a<h;a++){var p=g.slice(f,f+=4),n=[],t=1==p[0]&&1==p[1]&&1==p[2],r=!(2==p[0]&&2==p[1]&&!(p[2]&128))&&!t;if(t)return console.error("%s: old run-length encoding is not supported",b),this.onerror();if(r)k[m++]=p[0],k[m++]=p[1],k[m++]=p[2],k[m++]=p[3];else{if((p[2]<<8)+p[3]!=c)return console.error("%s: HDR line mismatch",
b),this.onerror();for(p=0;4>p;p++){t=p*c;r=(p+1)*c;for(var u,q;t<r;)if(u=g.slice(f,f+=2),128<u[0])for(q=u[0]-128;0<q--;)n[t++]=u[1];else for(q=u[0]-1,n[t++]=u[1];0<q--;)n[t++]=g[f++]}for(p=0;p<c;p++)k[m++]=n[p],k[m++]=n[p+c],k[m++]=n[p+2*c],k[m++]=n[p+3*c]}}d&&d(k,c,h)};f.open("GET",b,!0);f.send(null);return f}function x(b,d){var f=b.byteLength/12|0;d=d||new Uint32Array(f);for(var c=0;c<f;c++){var l=Math.min(32768,b[3*c]);var g=Math.min(32768,b[3*c+1]);var h=Math.min(32768,b[3*c+2]);var k=Math.max(Math.max(l,
g),h);var m=Math.max(-16,Math.floor(Math.log2(k)))+16;var a=Math.pow(2,m-24);511==Math.floor(k/a+.5)&&(a*=2,m+=1);d[c]=(Math.floor(l/a+.5)<<23)+(Math.floor(g/a+.5)<<14)+(Math.floor(h/a+.5)<<5)+(m|0)}return d}function z(b,d){var f=b.byteLength>>2;d=d||new Float32Array(3*f);for(var c=0;c<f;c++){var l=b[c];var g=Math.pow(2,(l&31)-24);d[3*c]=(l>>>23)*g;d[3*c+1]=(l>>>14&511)*g;d[3*c+2]=(l>>>5&511)*g}return d}function y(b,d){var f=b.byteLength/12|0;d=d||new Uint8Array(4*f);for(var c=0;c<f;c++){var l=b[3*
c];var g=b[3*c+1];var h=b[3*c+2];var k=Math.max(Math.max(l,g),h);e=Math.ceil(Math.log2(k));k=Math.pow(2,e-8);d[4*c]=l/k|0;d[4*c+1]=g/k|0;d[4*c+2]=h/k|0;d[4*c+3]=e+128}return d}function w(b,d){var f=b.byteLength>>2;d=d||new Float32Array(3*f);for(var c=0;c<f;c++){var l=Math.pow(2,b[4*c+3]-136);d[3*c]=b[4*c]*l;d[3*c+1]=b[4*c+1]*l;d[3*c+2]=b[4*c+2]*l}return d}function r(b,d,f,c){d=Math.pow(2,void 0===d?1:d)/2;void 0===f&&(f=2.2);f=1/f;var l=b.byteLength>>2;c=c||new Uint8ClampedArray(4*l);for(var g=0;g<
l;g++){var h=d*Math.pow(2,b[4*g+3]-136);c[4*g]=255*Math.pow(b[4*g]*h,f);c[4*g+1]=255*Math.pow(b[4*g+1]*h,f);c[4*g+2]=255*Math.pow(b[4*g+2]*h,f);c[4*g+3]=255}return c}n.floatToRgbe=y;n.rgbeToFloat=w;n.floatToRgb9_e5=x;n.rgb9_e5ToFloat=z;n.rgbeToLDR=r;n.floatToLDR=function(b,d,f,c){d=Math.pow(2,void 0===d?1:d)/2;void 0===f&&(f=2.2);f=1/f;var l=b.byteLength/12|0;c=c||new Uint8ClampedArray(4*l);for(var g=0;g<l;g++)c[4*g]=255*Math.pow(b[3*g]*d,f),c[4*g+1]=255*Math.pow(b[3*g+1]*d,f),c[4*g+2]=255*Math.pow(b[3*
g+2]*d,f),c[4*g+3]=255;return c};return n});